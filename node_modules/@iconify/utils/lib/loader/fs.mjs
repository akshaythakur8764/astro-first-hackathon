import { promises } from 'fs';
import { isPackageExists, resolveModule, importModule } from 'local-pkg';
import { tryInstallPkg } from './install-pkg.mjs';
import '@antfu/install-pkg';
import '@antfu/utils';
import 'kolorist';
import './warn.mjs';

const _collections = {};
const isLegacyExists = isPackageExists("@iconify/json");
async function loadCollectionFromFS(name, autoInstall = false, scope = "@iconify-json") {
  if (!await _collections[name]) {
    _collections[name] = task();
  }
  return _collections[name];
  async function task() {
    const packageName = scope.length === 0 ? name : `${scope}/${name}`;
    let jsonPath = resolveModule(`${packageName}/icons.json`);
    if (scope === "@iconify-json") {
      if (!jsonPath && isLegacyExists) {
        jsonPath = resolveModule(`@iconify/json/json/${name}.json`);
      }
      if (!jsonPath && !isLegacyExists && autoInstall) {
        await tryInstallPkg(packageName, autoInstall);
        jsonPath = resolveModule(`${packageName}/icons.json`);
      }
    } else if (!jsonPath && autoInstall) {
      await tryInstallPkg(packageName, autoInstall);
      jsonPath = resolveModule(`${packageName}/icons.json`);
    }
    if (!jsonPath) {
      let packagePath = resolveModule(packageName);
      if (packagePath?.match(/^[a-z]:/i)) {
        packagePath = `file:///${packagePath}`.replace(/\\/g, "/");
      }
      if (packagePath) {
        const { icons } = await importModule(
          packagePath
        );
        if (icons)
          return icons;
      }
    }
    let stat;
    try {
      stat = jsonPath ? await promises.lstat(jsonPath) : void 0;
    } catch (err) {
      return void 0;
    }
    if (stat?.isFile()) {
      return JSON.parse(
        await promises.readFile(jsonPath, "utf8")
      );
    } else {
      return void 0;
    }
  }
}

export { loadCollectionFromFS };
